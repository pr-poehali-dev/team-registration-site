<?php
/**
 * Telegram Bot Webhook Handler
 * 
 * PHP –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –æ–±—ã—á–Ω–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ Timeweb (–±–µ–∑ VPS)
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç webhook –≤–º–µ—Å—Ç–æ long polling
 * 
 * –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
 * - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
 * - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–º–∞–Ω–¥—ã
 * - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
 * - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–Ω–∞–º
 */

header('Content-Type: application/json; charset=utf-8');

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
require_once __DIR__ . '/../config.php';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
define('BOT_TOKEN', '8008657360:AAGUdeZTn_s0YMfB7LjQHSKd0cGXnt5yxds');
define('API_URL', 'https://api.telegram.org/bot' . BOT_TOKEN . '/');

// –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç Telegram
$content = file_get_contents('php://input');
$update = json_decode($content, true);

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
error_log("Telegram Update: " . $content);

if (!$update) {
    exit('No update');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–Ω–æ–ø–∫–∏)
if (isset($update['callback_query'])) {
    handleCallbackQuery($update['callback_query']);
    exit;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
if (isset($update['message'])) {
    $message = $update['message'];
    $chat_id = $message['chat']['id'];
    $text = $message['text'] ?? '';
    $username = $message['from']['username'] ?? '';
    
    // –ö–æ–º–∞–Ω–¥–∞ /start
    if ($text === '/start') {
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å chat_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        $stmt = $pdo->prepare("
            INSERT INTO telegram_users (chat_id, username, first_name, last_name, updated_at) 
            VALUES (?, ?, ?, ?, NOW())
            ON DUPLICATE KEY UPDATE 
                chat_id = VALUES(chat_id),
                first_name = VALUES(first_name),
                last_name = VALUES(last_name),
                updated_at = NOW()
        ");
        
        $stmt->execute([
            $chat_id,
            $username,
            $message['from']['first_name'] ?? '',
            $message['from']['last_name'] ?? ''
        ]);
        
        sendMessage($chat_id, 
            "üèÜ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–≥–æ –±–æ—Ç–∞ League of Legends!*\n\n" .
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" .
            "/register - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É\n" .
            "/myteam - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ—é –∫–æ–º–∞–Ω–¥—É\n" .
            "/help - –ü–æ–º–æ—â—å\n\n" .
            "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚¨áÔ∏è",
            [
                'inline_keyboard' => [[
                    ['text' => 'üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É', 'callback_data' => 'register_start']
                ]]
            ]
        );
    }
    // –ö–æ–º–∞–Ω–¥–∞ /register
    elseif ($text === '/register') {
        sendMessage($chat_id,
            "üìù *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã*\n\n" .
            "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç:\n" .
            "üëâ https://ce876244.tw1.ru/\n\n" .
            "–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π."
        );
    }
    // –ö–æ–º–∞–Ω–¥–∞ /myteam
    elseif ($text === '/myteam') {
        showMyTeam($chat_id, $username);
    }
    // –ö–æ–º–∞–Ω–¥–∞ /help
    elseif ($text === '/help') {
        sendMessage($chat_id,
            "‚ÑπÔ∏è *–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É*\n\n" .
            "*–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:*\n" .
            "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç —Ç—É—Ä–Ω–∏—Ä–∞\n" .
            "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n" .
            "3. –í—ã –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —ç—Ç–æ—Ç —á–∞—Ç\n\n" .
            "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π:*\n" .
            "- –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–∞–π—Ç–µ\n" .
            "- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞\n\n" .
            "*–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:*\n" .
            "üåê –°–∞–π—Ç: https://ce876244.tw1.ru/\n" .
            "üí¨ –°–æ–æ–±—â–µ—Å—Ç–≤–æ: https://t.me/+QgiLIa1gFRY4Y2Iy"
        );
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Ñ–æ—Ä–º–∞—Ç REG-XXXX-XXXX)
    elseif (preg_match('/^REG-[A-Z0-9]{4}-[A-Z0-9]{4}$/i', $text)) {
        verifyAuthCode($chat_id, strtoupper($text));
    }
    else {
        sendMessage($chat_id,
            "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\n\n" .
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" .
            "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n" .
            "/register - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã\n" .
            "/myteam - –ú–æ—è –∫–æ–º–∞–Ω–¥–∞\n" .
            "/help - –ü–æ–º–æ—â—å"
        );
    }
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
 */
function handleCallbackQuery($callback) {
    global $pdo;
    
    $chat_id = $callback['message']['chat']['id'];
    $message_id = $callback['message']['message_id'];
    $data = $callback['data'];
    $callback_id = $callback['id'];
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    if (strpos($data, 'confirm_edit_') === 0) {
        $team_id = (int)str_replace('confirm_edit_', '', $data);
        confirmTeamEdit($chat_id, $message_id, $team_id, $callback_id);
    }
    // –û—Ç–º–µ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    elseif (strpos($data, 'cancel_edit_') === 0) {
        $team_id = (int)str_replace('cancel_edit_', '', $data);
        cancelTeamEdit($chat_id, $message_id, $team_id, $callback_id);
    }
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    elseif (strpos($data, 'confirm_delete_') === 0) {
        $team_id = (int)str_replace('confirm_delete_', '', $data);
        confirmTeamDelete($chat_id, $message_id, $team_id, $callback_id);
    }
    // –û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    elseif (strpos($data, 'cancel_delete_') === 0) {
        $team_id = (int)str_replace('cancel_delete_', '', $data);
        cancelTeamDelete($chat_id, $message_id, $team_id, $callback_id);
    }
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
    elseif ($data === 'register_start') {
        answerCallback($callback_id, "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
        sendMessage($chat_id,
            "üìù *–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã*\n\n" .
            "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:\n" .
            "üëâ https://ce876244.tw1.ru/\n\n" .
            "–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–¥ –≤ —ç—Ç–æ—Ç —á–∞—Ç."
        );
    }
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å –º–æ—é –∫–æ–º–∞–Ω–¥—É
 */
function showMyTeam($chat_id, $username) {
    global $pdo;
    
    if (!$username) {
        sendMessage($chat_id, "‚ùå –£ –≤–∞—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω username –≤ Telegram. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è.");
        return;
    }
    
    // –ù–∞–π—Ç–∏ –∫–æ–º–∞–Ω–¥—É –ø–æ telegram –∫–∞–ø–∏—Ç–∞–Ω–∞
    $stmt = $pdo->prepare("SELECT * FROM teams WHERE captain_telegram LIKE ? ORDER BY created_at DESC LIMIT 1");
    $stmt->execute(['%' . $username . '%']);
    $team = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$team) {
        sendMessage($chat_id,
            "‚ùå –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n" .
            "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–∞–π—Ç–µ:\n" .
            "üëâ https://ce876244.tw1.ru/"
        );
        return;
    }
    
    $status_emoji = [
        'pending' => '‚è≥',
        'approved' => '‚úÖ',
        'rejected' => '‚ùå'
    ];
    
    $status_text = [
        'pending' => '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
        'approved' => '–û–¥–æ–±—Ä–µ–Ω–∞',
        'rejected' => '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
    ];
    
    $message = "üèÜ *" . htmlspecialchars($team['team_name']) . "*\n\n";
    $message .= "üë§ *–ö–∞–ø–∏—Ç–∞–Ω:* " . htmlspecialchars($team['captain_name']) . "\n";
    $message .= "üì± *Telegram:* @" . htmlspecialchars($team['captain_telegram']) . "\n\n";
    $message .= "üë• *–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã:*\n";
    $message .= htmlspecialchars($team['members_info']) . "\n\n";
    $message .= $status_emoji[$team['status']] . " *–°—Ç–∞—Ç—É—Å:* " . $status_text[$team['status']] . "\n";
    $message .= "üîë *–ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:* `" . $team['auth_code'] . "`\n\n";
    
    if ($team['admin_comment']) {
        $message .= "üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∞:*\n" . htmlspecialchars($team['admin_comment']) . "\n\n";
    }
    
    $message .= "–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ —Å–∞–π—Ç–µ:\n";
    $message .= "üëâ https://ce876244.tw1.ru/";
    
    sendMessage($chat_id, $message);
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
 */
function verifyAuthCode($chat_id, $auth_code) {
    global $pdo;
    
    $stmt = $pdo->prepare("SELECT * FROM teams WHERE auth_code = ?");
    $stmt->execute([$auth_code]);
    $team = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$team) {
        sendMessage($chat_id, "‚ùå –ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞.");
        return;
    }
    
    sendMessage($chat_id, 
        "‚úÖ *–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!*\n\n" .
        "–ö–æ–º–∞–Ω–¥–∞: *" . htmlspecialchars($team['team_name']) . "*\n" .
        "–ö–∞–ø–∏—Ç–∞–Ω: " . htmlspecialchars($team['captain_name']) . "\n\n" .
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /myteam –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–∞–Ω–¥–µ."
    );
}

/**
 * –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
 */
function confirmTeamEdit($chat_id, $message_id, $team_id, $callback_id) {
    global $pdo;
    
    // –ü–æ–ª—É—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ pending_changes
    $stmt = $pdo->prepare("SELECT * FROM pending_changes WHERE team_id = ? ORDER BY created_at DESC LIMIT 1");
    $stmt->execute([$team_id]);
    $pending = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$pending) {
        answerCallback($callback_id, "–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        return;
    }
    
    $changes = json_decode($pending['changes'], true);
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –∫–æ–º–∞–Ω–¥–µ
    $update_fields = [];
    $update_values = [];
    
    foreach ($changes as $field => $value) {
        $update_fields[] = "$field = ?";
        $update_values[] = $value;
    }
    
    $update_values[] = $team_id;
    
    $sql = "UPDATE teams SET " . implode(', ', $update_fields) . " WHERE id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute($update_values);
    
    // –£–¥–∞–ª–∏—Ç—å –∏–∑ pending_changes
    $stmt = $pdo->prepare("DELETE FROM pending_changes WHERE id = ?");
    $stmt->execute([$pending['id']]);
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    editMessage($chat_id, $message_id,
        "‚úÖ *–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!*\n\n" .
        "–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞."
    );
    
    answerCallback($callback_id, "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã");
}

/**
 * –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
 */
function cancelTeamEdit($chat_id, $message_id, $team_id, $callback_id) {
    global $pdo;
    
    // –£–¥–∞–ª–∏—Ç—å –∏–∑ pending_changes
    $stmt = $pdo->prepare("DELETE FROM pending_changes WHERE team_id = ? ORDER BY created_at DESC LIMIT 1");
    $stmt->execute([$team_id]);
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    editMessage($chat_id, $message_id,
        "‚ùå *–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã*\n\n" .
        "–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
    );
    
    answerCallback($callback_id, "‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã");
}

/**
 * –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
 */
function confirmTeamDelete($chat_id, $message_id, $team_id, $callback_id) {
    global $pdo;
    
    // –£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
    $stmt = $pdo->prepare("DELETE FROM teams WHERE id = ?");
    $stmt->execute([$team_id]);
    
    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    editMessage($chat_id, $message_id,
        "‚úÖ *–ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∞*\n\n" .
        "–í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
    );
    
    answerCallback($callback_id, "‚úÖ –ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∞");
}

/**
 * –û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
 */
function cancelTeamDelete($chat_id, $message_id, $team_id, $callback_id) {
    editMessage($chat_id, $message_id,
        "‚ùå *–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ*\n\n" .
        "–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞."
    );
    
    answerCallback($callback_id, "‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ");
}

/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
function sendMessage($chat_id, $text, $reply_markup = null) {
    $data = [
        'chat_id' => $chat_id,
        'text' => $text,
        'parse_mode' => 'Markdown'
    ];
    
    if ($reply_markup) {
        $data['reply_markup'] = json_encode($reply_markup);
    }
    
    return callAPI('sendMessage', $data);
}

/**
 * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
function editMessage($chat_id, $message_id, $text, $reply_markup = null) {
    $data = [
        'chat_id' => $chat_id,
        'message_id' => $message_id,
        'text' => $text,
        'parse_mode' => 'Markdown'
    ];
    
    if ($reply_markup) {
        $data['reply_markup'] = json_encode($reply_markup);
    }
    
    return callAPI('editMessageText', $data);
}

/**
 * –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback
 */
function answerCallback($callback_id, $text) {
    return callAPI('answerCallbackQuery', [
        'callback_query_id' => $callback_id,
        'text' => $text
    ]);
}

/**
 * –í—ã–∑–æ–≤ API Telegram
 */
function callAPI($method, $data) {
    $url = API_URL . $method;
    
    $options = [
        'http' => [
            'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
            'method'  => 'POST',
            'content' => http_build_query($data),
            'timeout' => 10
        ]
    ];
    
    $context = stream_context_create($options);
    $result = @file_get_contents($url, false, $context);
    
    return json_decode($result, true);
}

// –û—Ç–≤–µ—Ç–∏—Ç—å Telegram —á—Ç–æ –≤—Å—ë –û–ö
http_response_code(200);
echo json_encode(['ok' => true]);